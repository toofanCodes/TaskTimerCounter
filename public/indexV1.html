<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Timer Counter</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #1e1e1e;
      color: #ffffff;
    }

    h1 {
      text-align: center;
      margin: 20px 0;
      font-size: 2em;
      color: #00d4ff;
    }

    input, button {
      padding: 10px;
      margin: 5px;
      border-radius: 6px;
      border: none;
      font-size: 1em;
    }

    input {
      background-color: #2c2c2c;
      color: #fff;
      border: 1px solid #444;
    }

    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background-color: #0056b3;
    }

    .container, .info, .log, .project-setup, .sprint-setup {
      width: 90%;
      max-width: 1200px;
      margin: 10px auto;
    }

    .project-setup, .sprint-setup, .info, .log {
      background-color: #2a2a2a;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }

    .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      gap: 20px;
    }

    .box {
      flex: 1;
      height: 180px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 3em;
      font-weight: bold;
      border-radius: 10px;
      text-align: center;
    }

    .timer {
      background-color: #111;
      color: #00ffcc;
      font-family: 'Courier New', Courier, monospace;
    }

    .counter {
      background-color: #198754;
      color: white;
    }

    .complete-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 1.4em;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 0 12px rgba(0,0,0,0.5);
      z-index: 2;
    }

    .complete-button:hover {
      background-color: #c82333;
    }

    #taskLog {
      list-style: none;
      padding-left: 0;
      max-height: 200px;
      overflow-y: auto;
    }

    #taskLog li {
      padding: 8px;
      margin-bottom: 5px;
      background-color: #333;
      border-left: 4px solid #00d4ff;
      font-size: 0.95em;
    }
  </style>
</head>
<body>
  <div class="project-setup">
  <h3>Project Details</h3>
  <select id="projectSelect" onchange="document.getElementById('projectName').value=this.value"></select>
  <input type="text" id="projectName" placeholder="Project Name">
  <input type="text" id="projectDesc" placeholder="Project Description">
  <button onclick="startProject()">Start Project</button>
  <div>Project Started: <span id="projectStart">-</span></div>
</div>

<div class="sprint-setup">
  <h3>Sprint Details</h3>
  <select id="sprintSelect" onchange="document.getElementById('sprintName').value=this.value"></select>
  <input type="text" id="sprintName" placeholder="Sprint Name">
  <button onclick="startSprint()">Start Sprint</button>
  <div>Sprint Started: <span id="sprintStart">-</span></div>
</div>

<div class="info">
  <div>
    <label for="taskName">Task Name: </label>
    <select id="taskSelect" onchange="document.getElementById('taskName').value=this.value"></select>
    <input type="text" id="taskName">
    <button onclick="startTask()">Start Task</button>
  </div>
  <div>Task Started At: <span id="startTime">-</span></div>
  <div>Total Time Spent: <span id="totalTime">0:00</span></div>
</div>

<div class="container">
  <div class="box timer">
    <span id="timer">0:00</span>
  </div>
  <div class="box counter">
    <span id="counter">0</span>
  </div>
  <button class="complete-button" onclick="resetAndCount()">✓</button>
</div>

<div class="log">
  <h3>Task Log</h3>
  <ul id="taskLog"></ul>
</div>

<button onclick="downloadCSV()" style="margin: 20px auto; display: block; background-color: #00d4ff; color: #000;">Export Log as CSV</button>

<script>
    let counter = 0;
    let seconds = 0;
    let totalSeconds = 0;
    let intervalId;
    let project = { name: '', description: '', started: '', totalSeconds: 0, sprints: [] };
    let currentSprint = { name: '', started: '', tasks: [] };

    const timerElement = document.getElementById('timer');
    const counterElement = document.getElementById('counter');
    const totalTimeElement = document.getElementById('totalTime');
    const startTimeElement = document.getElementById('startTime');
    const taskLogElement = document.getElementById('taskLog');

    function formatTime(sec) {
      let mins = Math.floor(sec / 60);
      let secs = sec % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function startProject() {
  const name = document.getElementById('projectName').value.trim();
  const desc = document.getElementById('projectDesc').value.trim();
  if (!name || !desc) return alert('Project name and description required.');

  fetch('/load-log')
    .then(res => res.json())
    .then(data => {
      const existingEntries = data.filter(entry => entry.project === name);

      if (existingEntries.length > 0) {
        // Project exists — load its sprint and tasks
        project = { name, description: desc, started: new Date().toLocaleString(), totalSeconds: 0, sprints: [] };
        document.getElementById('projectStart').textContent = project.started;
        taskLogElement.innerHTML = '';

        existingEntries.forEach(entry => {
          const listItem = document.createElement('li');
          listItem.textContent = `Project: ${entry.project}, Sprint: ${entry.sprint}, Task: ${entry.task} - ${entry.duration}`;
          taskLogElement.appendChild(listItem);
        });

        const totalTime = existingEntries.reduce((acc, entry) => {
          const [min, sec] = entry.duration.split(':').map(Number);
          return acc + (min * 60 + sec);
        }, 0);

        totalSeconds = totalTime;
        totalTimeElement.textContent = formatTime(totalSeconds);
        counter = existingEntries.length;
        counterElement.textContent = counter;
      } else {
        // New project, reset
        project = { name, description: desc, started: new Date().toLocaleString(), totalSeconds: 0, sprints: [] };
        document.getElementById('projectStart').textContent = project.started;
        currentSprint = { name: '', started: '', tasks: [] };
        counter = 0;
        totalSeconds = 0;
        taskLogElement.innerHTML = '';
        totalTimeElement.textContent = '0:00';
        counterElement.textContent = '0';
      }
    });
    }

    function startSprint() {
  const name = document.getElementById('sprintName').value.trim();
  if (!name) return alert('Sprint name required.');

  fetch('/load-log')
    .then(res => res.json())
    .then(data => {
      const existingSprintEntries = data.filter(entry => entry.project === project.name && entry.sprint === name);

      if (existingSprintEntries.length > 0) {
        currentSprint = { name, started: new Date().toLocaleString(), tasks: [] };
        document.getElementById('sprintStart').textContent = currentSprint.started;
        taskLogElement.innerHTML = '';

        existingSprintEntries.forEach(entry => {
          const listItem = document.createElement('li');
          listItem.textContent = `Project: ${entry.project}, Sprint: ${entry.sprint}, Task: ${entry.task} - ${entry.duration}`;
          taskLogElement.appendChild(listItem);
        });

        const sprintTime = existingSprintEntries.reduce((acc, entry) => {
          const [min, sec] = entry.duration.split(':').map(Number);
          return acc + (min * 60 + sec);
        }, 0);

        totalSeconds = sprintTime;
        totalTimeElement.textContent = formatTime(totalSeconds);
        counter = existingSprintEntries.length;
        counterElement.textContent = counter;
      } else {
        currentSprint = { name, started: new Date().toLocaleString(), tasks: [] };
        document.getElementById('sprintStart').textContent = currentSprint.started;
        counter = 0;
        totalSeconds = 0;
        taskLogElement.innerHTML = '';
        totalTimeElement.textContent = '0:00';
        counterElement.textContent = '0';
      }
    });
    }

    function startTask() {
      const taskInput = document.getElementById('taskName');
      if (!taskInput.value.trim()) {
        alert("Please enter a task name.");
        return;
      }
      if (intervalId) clearInterval(intervalId);
      seconds = 0;
      timerElement.textContent = '0:00';
      startTimeElement.textContent = new Date().toLocaleTimeString();
      intervalId = setInterval(() => {
        seconds++;
        timerElement.textContent = formatTime(seconds);

        localStorage.setItem('activeTask', JSON.stringify({
          taskName: taskInput.value.trim(),
          seconds,
          startTime: startTimeElement.textContent
        }));
      }, 1000);
    }

    function resetAndCount() {
      const taskName = document.getElementById('taskName').value.trim();
      if (!taskName) {
        alert("Please start a task first.");
        return;
      }

      counter++;
      totalSeconds += seconds;
      project.totalSeconds += seconds;

      const taskEntry = {
        name: taskName,
        duration: formatTime(seconds),
        timestamp: new Date().toLocaleString()
      };

      currentSprint.tasks.push(taskEntry);

      const listItem = document.createElement('li');
      listItem.textContent = `Project: ${project.name}, Sprint: ${currentSprint.name}, Task: ${taskEntry.name} - ${taskEntry.duration}`;
      taskLogElement.appendChild(listItem);

      counterElement.textContent = counter;
      timerElement.textContent = '0:00';
      totalTimeElement.textContent = formatTime(totalSeconds);
      seconds = 0;
      clearInterval(intervalId);
      localStorage.removeItem('activeTask');

      fetch('/save-log', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          project: project.name,
          projectDescription: project.description,
          projectStarted: project.started,
          sprint: currentSprint.name,
          sprintStarted: currentSprint.started,
          sprint: currentSprint.name,
          task: taskEntry.name,
          status: 'completed',
          duration: taskEntry.duration,
          timestamp: taskEntry.timestamp,
          secondsSpent: seconds,
          counter: counter,
          totalProjectSeconds: project.totalSeconds
        })
      }).then(() => {
        alert('Task saved successfully!');
      }).catch(err => alert('Failed to save task: ' + err));
    }

    setInterval(() => {
      const now = new Date();
      const snapshotEntry = {
        project: project.name || 'Unnamed Project',
        sprint: currentSprint.name || 'Unnamed Sprint',
        task: 'AUTO_SAVE_SNAPSHOT',
        duration: formatTime(totalSeconds),
        timestamp: now.toLocaleString()
      };

      fetch('/save-log', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(snapshotEntry)
      }).then(() => {
        console.log('Snapshot saved');
      }).catch(err => console.error('Snapshot save failed', err));
    }, 30 * 60 * 1000);

    window.onload = () => {
  // Populate dropdowns from existing log
  fetch('/load-log')
    .then(res => res.json())
    .then(data => {
      const projects = new Set();
      const sprints = new Set();
      const tasks = new Set();

      data.forEach(entry => {
        if (entry.task !== 'AUTO_SAVE_SNAPSHOT') {
          projects.add(entry.project);
          sprints.add(entry.sprint);
          tasks.add(entry.task);
        }
      });

      const projectSelect = document.getElementById('projectSelect');
      const sprintSelect = document.getElementById('sprintSelect');
      const taskSelect = document.getElementById('taskSelect');

      projects.forEach(p => {
        const option = document.createElement('option');
        option.value = option.textContent = p;
        projectSelect.appendChild(option);
      });

      projectSelect.addEventListener('change', () => {
        const selectedProject = projectSelect.value;
        const filteredSprints = data.filter(entry => entry.project === selectedProject).map(entry => entry.sprint);
        const uniqueSprints = Array.from(new Set(filteredSprints));
        sprintSelect.innerHTML = '<option value="">-- Select Sprint --</option>';
        uniqueSprints.forEach(s => {
          const option = document.createElement('option');
          option.value = option.textContent = s;
          sprintSelect.appendChild(option);
        });
      });

      sprints.forEach(s => {
        const option = document.createElement('option');
        option.value = option.textContent = s;
        sprintSelect.appendChild(option);
      });

      tasks.forEach(t => {
        const option = document.createElement('option');
        option.value = option.textContent = t;
        taskSelect.appendChild(option);
      });
    }); // <-- This closes the first .then from project/sprint/task dropdown load
  fetch('/load-log')
    .then(res => res.json())
    .then(data => {
      const latestLog = data.reverse().find(entry => entry.task !== 'AUTO_SAVE_SNAPSHOT');

      data.forEach(entry => {
        if (entry.task !== 'AUTO_SAVE_SNAPSHOT') {
          const listItem = document.createElement('li');
          listItem.textContent = `Project: ${entry.project}, Sprint: ${entry.sprint}, Task: ${entry.task} - ${entry.duration}`;
          taskLogElement.appendChild(listItem);
        }
      });

      if (latestLog) {
        project.name = latestLog.project;
        currentSprint.name = latestLog.sprint;
        document.getElementById('projectName').value = latestLog.project;
        document.getElementById('sprintName').value = latestLog.sprint;
      }

      const durationSeconds = data.reduce((acc, entry) => {
        if (entry.task !== 'AUTO_SAVE_SNAPSHOT') {
          const [min, sec] = entry.duration.split(':').map(Number);
          acc += min * 60 + sec;
        }
        return acc;
      }, 0);

      totalSeconds = durationSeconds;
      totalTimeElement.textContent = formatTime(totalSeconds);
      counter = data.filter(entry => entry.task !== 'AUTO_SAVE_SNAPSHOT').length;
      counterElement.textContent = counter;

      const savedTask = JSON.parse(localStorage.getItem('activeTask'));
      if (savedTask && savedTask.taskName) {
        document.getElementById('taskName').value = savedTask.taskName;
        seconds = savedTask.seconds || 0;
        startTimeElement.textContent = savedTask.startTime || new Date().toLocaleTimeString();
        timerElement.textContent = formatTime(seconds);

        if (intervalId) clearInterval(intervalId);

        intervalId = setInterval(() => {
          seconds++;
          timerElement.textContent = formatTime(seconds);
          localStorage.setItem('activeTask', JSON.stringify({
            taskName: savedTask.taskName,
            seconds,
            startTime: startTimeElement.textContent
          }));
        }, 1000);
      }
    });
};

    function downloadCSV() {
      window.location.href = '/log.csv';
    }
  window.addEventListener('beforeunload', () => {
  if (seconds > 0 && document.getElementById('taskName').value.trim()) {
    const autoSave = {
      project: project.name || 'Unnamed Project',
      sprint: currentSprint.name || 'Unnamed Sprint',
      task: 'AUTO_SAVE_ON_REFRESH',
      duration: formatTime(seconds),
      timestamp: new Date().toLocaleString()
    };
    navigator.sendBeacon('/save-log', new Blob([
      JSON.stringify(autoSave)
    ], { type: 'application/json' }));
    // alert removed for silent unload auto-save
  }
});

// Periodic background auto-save every 30 seconds
setInterval(() => {
  if (seconds > 0 && document.getElementById('taskName').value.trim()) {
    const autoSave = {
      project: project.name || 'Unnamed Project',
      sprint: currentSprint.name || 'Unnamed Sprint',
      task: 'AUTO_SAVE_TASK_TIMER',
      duration: formatTime(seconds),
      timestamp: new Date().toLocaleString()
    };

    fetch('/save-log', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(autoSave)
    }).then(() => {
      console.log('Auto-saved to server');
      // alert removed for silent auto-save
    }).catch(err => console.error('Auto-save failed', err));
  }
}, 30000);
</script>
</body>
</html>